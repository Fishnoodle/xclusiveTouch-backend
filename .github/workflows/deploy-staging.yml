name: Deploy Staging to DigitalOcean

on:
  push:
    branches:
      - staging
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  deploy:
    name: SSH Deploy Staging
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          echo "ðŸ” Setting up SSH..."
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.DROPLET_HOST }} >> ~/.ssh/known_hosts
          echo "âœ… SSH setup complete."

      - name: Deploy Staging to Droplet
        run: |
          echo "ðŸš€ Connecting to droplet for STAGING deployment..."

          ssh -p ${{ secrets.DROPLET_PORT }} ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'EOF'
          set -e  # Exit on any error

          echo "ðŸ“‚ Moving to STAGING app directory..."
          cd /root/xclusiveTouch-backend-staging

          echo "ðŸ“¥ Pulling latest staging code..."
          git pull origin staging

          echo "ðŸ“¦ Installing dependencies..."
          npm install --production

          echo "ðŸ”„ Reloading PM2 for STAGING..."
          pm2 reload xclusive-staging || pm2 restart xclusive-staging

          echo "ðŸ“Š PM2 Status:"
          pm2 status

          echo "ðŸ“ Recent STAGING logs:"
          pm2 logs xclusive-staging --lines 20 --nostream

          echo "ðŸ’¾ Saving PM2..."
          pm2 save

          echo "âœ… STAGING deployment complete!"

          EOF

      - name: Deployment Success
        if: success()
        run: |
          echo "=========================================="
          echo "ðŸŽ‰ STAGING DEPLOYMENT SUCCESSFUL!"
          echo "ðŸŒ Staging API: https://staging-api.xclusivetouch.ca"
          echo "=========================================="

      - name: Deployment Failed
        if: failure()
        run: |
          echo "=========================================="
          echo "âŒ STAGING DEPLOYMENT FAILED!"
          echo "Check logs above for details"
          echo "=========================================="
