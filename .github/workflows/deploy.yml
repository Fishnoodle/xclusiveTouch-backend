name: Deploy Backend to DigitalOcean

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  deploy:
    name: SSH Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          echo "ðŸ” Setting up SSH..."
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.DROPLET_HOST }} >> ~/.ssh/known_hosts
          echo "âœ… SSH setup complete."

      - name: Deploy to Droplet
        run: |
          echo "ðŸš€ Connecting to droplet..."

          ssh -p ${{ secrets.DROPLET_PORT }} ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'EOF'
          set -e  # Exit on any error

          echo "ðŸ“‚ Moving to app directory..."
          cd /root/xclusiveTouch-backend

          echo "ðŸ“¥ Pulling latest code..."
          git pull origin main

          echo "ðŸ“¦ Installing dependencies..."
          npm install --production

          echo "ðŸ”„ Reloading PM2..."
          pm2 reload index || pm2 restart index

          echo "ðŸ“Š PM2 Status:"
          pm2 status

          echo "ðŸ“ Recent logs:"
          pm2 logs index --lines 20 --nostream

          echo "ðŸ’¾ Saving PM2..."
          pm2 save

          echo "âœ… Deployment complete!"

          EOF

      - name: Deployment Success
        if: success()
        run: |
          echo "=========================================="
          echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
          echo "=========================================="

      - name: Deployment Failed
        if: failure()
        run: |
          echo "=========================================="
          echo "âŒ DEPLOYMENT FAILED!"
          echo "Check logs above for details"
          echo "=========================================="
